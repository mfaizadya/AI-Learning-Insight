{
	"info": {
		"_postman_id": "user-profile-ops-2024",
		"name": "User Profile Operations",
		"description": "# User Profile Operations Test Collection\n\n## Overview\nThis collection tests the complete user profile lifecycle: create user, check own profile, update own profile, and delete own profile. It follows the user data management specification requirements.\n\n## Test Flow\n1. **Create User** - Register a new user account\n2. **Check Own Profile** - Retrieve the user's profile information\n3. **Update Own Profile** - Modify profile fields (username, email, etc.)\n4. **Delete Own Profile** - Soft delete the user account\n\n## Prerequisites\n- API Server running at configured baseUrl\n- Environment variables configured: `baseUrl`\n\n## Environment Variables\n**Required:**\n- `baseUrl` - API server URL (e.g., http://localhost:3000/api)\n\n**Auto-generated:**\n- `profileTestUserEmail` - Generated test user email\n- `profileTestUserPassword` - Generated test user password\n- `profileTestUserId` - Created user ID\n- `profileTestUserToken` - Authentication token\n\n## Expected Results\n- All 4 main operations should pass\n- User profile data should be consistent across operations\n- Soft delete should prevent further authentication\n- No manual cleanup required (user is deleted as part of test)",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Create User",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Generate unique credentials for this test run",
							"const timestamp = Date.now();",
							"const random = Math.random().toString(36).substring(2, 8);",
							"const email = `profile_test_${timestamp}_${random}@example.com`;",
							"const username = `profile_user_${timestamp}_${random}`;",
							"const password = 'ProfileTest123!';",
							"",
							"// Store credentials for use throughout the test",
							"pm.environment.set('profileTestUserEmail', email);",
							"pm.environment.set('profileTestUserUsername', username);",
							"pm.environment.set('profileTestUserPassword', password);",
							"",
							"console.log('Creating profile test user:', email);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Validate user creation response",
							"pm.test('Status code is 201 Created', function () {",
							"    pm.response.to.have.status(201);",
							"});",
							"",
							"pm.test('Response has success field set to true', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"});",
							"",
							"pm.test('Response contains user data with required fields', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('data');",
							"    pm.expect(jsonData.data).to.have.property('id');",
							"    pm.expect(jsonData.data).to.have.property('email');",
							"    pm.expect(jsonData.data).to.have.property('username');",
							"    pm.expect(jsonData.data).to.have.property('role');",
							"});",
							"",
							"pm.test('User ID is captured for subsequent requests', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.data.id).to.be.a('number');",
							"    pm.environment.set('profileTestUserId', jsonData.data.id);",
							"    console.log('Profile test user ID captured:', jsonData.data.id);",
							"});",
							"",
							"pm.test('Email matches generated email', function () {",
							"    const jsonData = pm.response.json();",
							"    const expectedEmail = pm.environment.get('profileTestUserEmail');",
							"    pm.expect(jsonData.data.email).to.equal(expectedEmail);",
							"});",
							"",
							"pm.test('Username matches generated username', function () {",
							"    const jsonData = pm.response.json();",
							"    const expectedUsername = pm.environment.get('profileTestUserUsername');",
							"    pm.expect(jsonData.data.username).to.equal(expectedUsername);",
							"});",
							"",
							"pm.test('Role is set to user', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.data.role).to.equal('user');",
							"});",
							"",
							"// Automatically login the user for subsequent requests",
							"setTimeout(() => {",
							"    pm.sendRequest({",
							"        url: pm.environment.get('baseUrl') + '/auth/login',",
							"        method: 'POST',",
							"        header: {",
							"            'Content-Type': 'application/json'",
							"        },",
							"        body: {",
							"            mode: 'raw',",
							"            raw: JSON.stringify({",
							"                email: pm.environment.get('profileTestUserEmail'),",
							"                password: pm.environment.get('profileTestUserPassword')",
							"            })",
							"        }",
							"    }, (err, response) => {",
							"        if (!err && response.code === 200) {",
							"            const loginData = response.json();",
							"            pm.environment.set('profileTestUserToken', loginData.data.token);",
							"            console.log('✓ User automatically logged in, token stored');",
							"        } else {",
							"            console.error('❌ Failed to auto-login user:', err || response.code);",
							"        }",
							"    });",
							"}, 100);"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"email\": \"{{profileTestUserEmail}}\",\n  \"username\": \"{{profileTestUserUsername}}\",\n  \"password\": \"{{profileTestUserPassword}}\",\n  \"role\": \"user\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/auth/register",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"auth",
						"register"
					]
				},
				"description": "Creates a new user account with dynamically generated credentials. The user is automatically logged in after creation to obtain an authentication token for subsequent profile operations."
			},
			"response": []
		},
		{
			"name": "2. Check Own Profile",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Verify that user token is available",
							"const token = pm.environment.get('profileTestUserToken');",
							"if (!token) {",
							"    console.warn('⚠️ User token not found. Make sure \"Create User\" ran successfully.');",
							"} else {",
							"    console.log('Checking profile for user:', pm.environment.get('profileTestUserEmail'));",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Validate profile retrieval response",
							"pm.test('Status code is 200 OK', function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test('Response has success field set to true', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"});",
							"",
							"pm.test('Response contains complete user profile data', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('data');",
							"    pm.expect(jsonData.data).to.have.property('id');",
							"    pm.expect(jsonData.data).to.have.property('email');",
							"    pm.expect(jsonData.data).to.have.property('username');",
							"    pm.expect(jsonData.data).to.have.property('role');",
							"});",
							"",
							"pm.test('Profile data matches created user', function () {",
							"    const jsonData = pm.response.json();",
							"    const expectedEmail = pm.environment.get('profileTestUserEmail');",
							"    const expectedUsername = pm.environment.get('profileTestUserUsername');",
							"    const expectedUserId = pm.environment.get('profileTestUserId');",
							"    ",
							"    pm.expect(jsonData.data.email).to.equal(expectedEmail);",
							"    pm.expect(jsonData.data.username).to.equal(expectedUsername);",
							"    pm.expect(jsonData.data.id).to.equal(expectedUserId);",
							"    pm.expect(jsonData.data.role).to.equal('user');",
							"});",
							"",
							"pm.test('Profile contains learning-related fields', function () {",
							"    const jsonData = pm.response.json();",
							"    // These fields may be null for new users, but should exist",
							"    pm.expect(jsonData.data).to.have.property('learning_style');",
							"    pm.expect(jsonData.data).to.have.property('learning_pattern');",
							"});",
							"",
							"pm.test('Sensitive data is not exposed', function () {",
							"    const jsonData = pm.response.json();",
							"    // Password should never be returned",
							"    pm.expect(jsonData.data).to.not.have.property('password');",
							"    pm.expect(jsonData.data).to.not.have.property('password_hash');",
							"});",
							"",
							"// Store original profile data for comparison after update",
							"const profileData = pm.response.json().data;",
							"pm.environment.set('originalProfileData', JSON.stringify(profileData));",
							"console.log('✓ Original profile data stored for update comparison');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{profileTestUserToken}}"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/users/profile",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"users",
						"profile"
					]
				},
				"description": "Retrieves the authenticated user's complete profile information. Validates that all expected fields are present and match the data from user creation. Stores original profile data for comparison after updates."
			},
			"response": []
		},
		{
			"name": "3. Update Own Profile",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Generate updated profile data",
							"const timestamp = Date.now();",
							"const updatedUsername = `updated_user_${timestamp}`;",
							"const updatedEmail = `updated_${timestamp}@example.com`;",
							"",
							"// Store updated values for validation",
							"pm.environment.set('updatedUsername', updatedUsername);",
							"pm.environment.set('updatedEmail', updatedEmail);",
							"",
							"console.log('Updating profile with new username:', updatedUsername);",
							"console.log('Updating profile with new email:', updatedEmail);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Validate profile update response",
							"pm.test('Status code is 200 OK', function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test('Response has success field set to true', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"});",
							"",
							"pm.test('Response contains updated user data', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('data');",
							"    pm.expect(jsonData.data).to.have.property('id');",
							"    pm.expect(jsonData.data).to.have.property('email');",
							"    pm.expect(jsonData.data).to.have.property('username');",
							"});",
							"",
							"pm.test('Username was updated successfully', function () {",
							"    const jsonData = pm.response.json();",
							"    const expectedUsername = pm.environment.get('updatedUsername');",
							"    pm.expect(jsonData.data.username).to.equal(expectedUsername);",
							"});",
							"",
							"pm.test('Email was updated successfully', function () {",
							"    const jsonData = pm.response.json();",
							"    const expectedEmail = pm.environment.get('updatedEmail');",
							"    pm.expect(jsonData.data.email).to.equal(expectedEmail);",
							"});",
							"",
							"pm.test('User ID remains unchanged', function () {",
							"    const jsonData = pm.response.json();",
							"    const expectedUserId = pm.environment.get('profileTestUserId');",
							"    pm.expect(jsonData.data.id).to.equal(expectedUserId);",
							"});",
							"",
							"pm.test('Role remains unchanged', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.data.role).to.equal('user');",
							"});",
							"",
							"pm.test('Unchanged fields are preserved', function () {",
							"    const jsonData = pm.response.json();",
							"    const originalData = JSON.parse(pm.environment.get('originalProfileData'));",
							"    ",
							"    // Fields that should remain the same",
							"    pm.expect(jsonData.data.id).to.equal(originalData.id);",
							"    pm.expect(jsonData.data.role).to.equal(originalData.role);",
							"    pm.expect(jsonData.data.learning_style).to.equal(originalData.learning_style);",
							"    pm.expect(jsonData.data.learning_pattern).to.equal(originalData.learning_pattern);",
							"});",
							"",
							"pm.test('Sensitive data is not exposed in update response', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.data).to.not.have.property('password');",
							"    pm.expect(jsonData.data).to.not.have.property('password_hash');",
							"});",
							"",
							"console.log('✓ Profile updated successfully with new data');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{profileTestUserToken}}"
					},
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"username\": \"{{updatedUsername}}\",\n  \"email\": \"{{updatedEmail}}\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/users/profile",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"users",
						"profile"
					]
				},
				"description": "Updates the authenticated user's profile information. Tests partial updates by modifying username and email while preserving other fields. Validates that only allowed fields can be updated and that unchanged fields remain intact."
			},
			"response": []
		},
		{
			"name": "4. Delete Own Profile",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Log the user being deleted",
							"const userId = pm.environment.get('profileTestUserId');",
							"const userEmail = pm.environment.get('updatedEmail') || pm.environment.get('profileTestUserEmail');",
							"",
							"console.log('Deleting user profile - ID:', userId, 'Email:', userEmail);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Validate profile deletion response",
							"pm.test('Status code is 200 OK', function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test('Response has success field set to true', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('success');",
							"    pm.expect(jsonData.success).to.be.true;",
							"});",
							"",
							"pm.test('Response contains deletion confirmation', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('message');",
							"    pm.expect(jsonData.message).to.be.a('string');",
							"    pm.expect(jsonData.message.toLowerCase()).to.include('deleted');",
							"});",
							"",
							"pm.test('Response contains deletion data', function () {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('data');",
							"    pm.expect(jsonData.data).to.have.property('deletedUserId');",
							"    pm.expect(jsonData.data).to.have.property('referentialIntegrity');",
							"});",
							"",
							"// Test that the user can no longer authenticate (soft delete verification)",
							"pm.test('Deleted user cannot authenticate', function () {",
							"    // This test will be performed via a follow-up request",
							"    setTimeout(() => {",
							"        pm.sendRequest({",
							"            url: pm.environment.get('baseUrl') + '/auth/login',",
							"            method: 'POST',",
							"            header: {",
							"                'Content-Type': 'application/json'",
							"            },",
							"            body: {",
							"                mode: 'raw',",
							"                raw: JSON.stringify({",
							"                    email: pm.environment.get('updatedEmail') || pm.environment.get('profileTestUserEmail'),",
							"                    password: pm.environment.get('profileTestUserPassword')",
							"                })",
							"            }",
							"        }, (err, response) => {",
							"            if (response && response.code === 401) {",
							"                console.log('✓ Deleted user correctly rejected from authentication');",
							"            } else {",
							"                console.warn('⚠️ Deleted user authentication test inconclusive:', response ? response.code : 'No response');",
							"            }",
							"        });",
							"    }, 100);",
							"});",
							"",
							"// Clean up environment variables",
							"pm.test('Environment cleanup completed', function () {",
							"    pm.environment.unset('profileTestUserEmail');",
							"    pm.environment.unset('profileTestUserUsername');",
							"    pm.environment.unset('profileTestUserPassword');",
							"    pm.environment.unset('profileTestUserId');",
							"    pm.environment.unset('profileTestUserToken');",
							"    pm.environment.unset('updatedUsername');",
							"    pm.environment.unset('updatedEmail');",
							"    pm.environment.unset('originalProfileData');",
							"    ",
							"    console.log('✓ Environment variables cleaned up');",
							"    pm.expect(true).to.be.true;",
							"});",
							"",
							"console.log('✓ User profile deleted successfully - test sequence complete');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "DELETE",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{profileTestUserToken}}"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/users/profile",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"users",
						"profile"
					]
				},
				"description": "Performs a soft delete of the authenticated user's profile. Validates that the deletion is successful and that the user can no longer authenticate. Automatically cleans up all environment variables used during the test sequence."
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Collection-level pre-request script",
					"// Validate that baseUrl is configured",
					"const baseUrl = pm.environment.get('baseUrl');",
					"if (!baseUrl) {",
					"    console.error('❌ baseUrl environment variable not set');",
					"    console.error('Please set baseUrl to your API server (e.g., http://localhost:3000/api)');",
					"} else {",
					"    console.log('Using API base URL:', baseUrl);",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Collection-level test script",
					"// Log test completion status",
					"if (pm.response.code >= 200 && pm.response.code < 300) {",
					"    console.log('✓ Request completed successfully');",
					"} else if (pm.response.code >= 400) {",
					"    console.warn('⚠️ Request failed with status:', pm.response.code);",
					"}"
				]
			}
		}
	]
}